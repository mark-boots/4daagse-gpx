<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4Daagse GPX</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Bekijk en download GPX routes van de Nijmegen Vierdaagse. Interactieve kaart met alle wandelroutes voor het 4Daagse evenement.">
    <meta name="keywords" content="4Daagse, Nijmegen, Vierdaagse, GPX, routes, wandelen, kaart, 2025, Nederland">
    <meta name="author" content="4Daagse GPX">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://mark-boots.github.io/4daagse-gpx/">
    
    <!-- Open Graph / Facebook Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mark-boots.github.io/4daagse-gpx/">
    <meta property="og:title" content="4Daagse GPX">
    <meta property="og:description" content="Bekijk en download GPX routes van de Nijmegen Vierdaagse. Interactieve kaart met alle wandelroutes voor het 4Daagse evenement.">
    <meta property="og:image" content="https://mark-boots.github.io/4daagse-gpx/og-image.png">
    <meta property="og:locale" content="nl_NL">
    <meta property="og:site_name" content="4Daagse GPX">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://mark-boots.github.io/4daagse-gpx/">
    <meta name="twitter:title" content="4Daagse GPX">
    <meta name="twitter:description" content="Bekijk en download GPX routes van de Nijmegen Vierdaagse. Interactieve kaart met alle wandelroutes voor het 4Daagse evenement.">
    <meta name="twitter:image" content="https://mark-boots.github.io/4daagse-gpx/og-image.png">
    
    <!-- Additional SEO -->
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" type="image/svg+xml" href="logo_icon.svg">
    
    <!-- Google Analytics will be loaded conditionally after cookie consent -->
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: auto;
            min-width: 280px;
            max-width: 350px;
            background: #2c3e50;
            color: white;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem 1rem;
            border-bottom: 1px solid #34495e;
            text-align: center;
            flex-shrink: 0;
        }
        
        .sidebar-header .logo {
            width: 48px;
            height: 48px;
            object-fit: contain;
            margin-bottom: 0.75rem;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        .sidebar-header h1 {
            font-size: 1.8rem;
            color: #ecf0f1;
            margin: 0 0 0.5rem 0;
        }
        
        .sidebar-header p {
            color: #bdc3c7;
            font-size: 0.9rem;
        }
        
        .sidebar-content {
            padding: 0.75rem;
            overflow-y: auto;
            flex: 1;
        }
        
        /* Custom scrollbar for sidebar */
        .sidebar-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .sidebar-content::-webkit-scrollbar-track {
            background: #2c3e50;
            border-radius: 4px;
        }
        
        .sidebar-content::-webkit-scrollbar-thumb {
            background: #5a6c7d;
            border-radius: 4px;
            border: 1px solid #2c3e50;
        }
        
        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: #6c7f91;
        }
        
        .sidebar-content::-webkit-scrollbar-thumb:active {
            background: #7d90a3;
        }
        
        /* Firefox scrollbar styling */
        .sidebar-content {
            scrollbar-width: thin;
            scrollbar-color: #5a6c7d #2c3e50;
        }
        
        .github-link {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #34495e;
            text-align: center;
        }
        
        .github-link a {
            color: #bdc3c7;
            text-decoration: none;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .github-link a:hover {
            color: #ecf0f1;
            background: #34495e;
        }
        
        .github-link .github-icon {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }
        
        .day-group {
            margin-bottom: 0.75rem;
            background: #34495e;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .day-group-header {
            padding: 0.75rem;
            cursor: pointer;
            user-select: none;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .day-group-header::after {
            content: '‚ñº';
            position: absolute;
            right: 0.75rem;
            transition: transform 0.2s ease;
            width: 20px;
            text-align: center;
        }
        
        .day-group-header.collapsed::after {
            transform: rotate(-90deg);
        }
        
        .day-group-header:hover {
            filter: brightness(1.1);
        }
        
        .day-group-header.day-1 {
            background-color: #3498db !important; /* Blue */
        }
        
        .day-group-header.day-2 {
            background-color: #e91e63 !important; /* Pink */
        }
        
        .day-group-header.day-3 {
            background-color: #4caf50 !important; /* Green */
        }
        
        .day-group-header.day-4 {
            background-color: #ff9800 !important; /* Orange */
        }

        .day-files {
            padding: 0;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .day-files.collapsed {
            max-height: 0;
        }
        
        .file-item {
            padding: 0.4rem 0.75rem;
            border-bottom: 1px solid #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            border-radius: 4px;
            margin: 0.1rem 0;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .file-item:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: rgba(255,255,255,0.05);
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            appearance: none;
            border: 2px solid;
            border-radius: 3px;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .file-checkbox:checked {
            background-color: currentColor;
        }
        
        .file-checkbox:checked::after {
            content: '‚úì';
            position: absolute;
            top: -1px;
            left: 1px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .file-info {
            flex-grow: 1;
            min-width: 0;
        }
        
        .file-name {
            font-size: 0.85rem;
            color: #ecf0f1;
            margin-bottom: 0;
            font-weight: 500;
            word-break: break-word;
            line-height: 1.2;
        }
        
        .file-meta {
            font-size: 0.75rem;
            color: #95a5a6;
            display: flex;
            gap: 0.4rem;
            align-items: center;
            margin-top: 0.1rem;
        }
        
        .file-type {
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .type-track {
            background: #27ae60;
            color: white;
        }
        
        .type-poi {
            background: #f39c12;
            color: white;
        }
        
        .download-link {
            color: #3498db;
            text-decoration: none;
            font-size: 0.7rem;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        
        .download-link:hover {
            color: #2980b9;
            text-decoration: underline;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .map-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            gap: 0.5rem;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.8rem;
            transition: background-color 0.2s ease;
        }
        
        .control-btn:hover {
            background: white;
        }
        
        .poi-icon {
            background: white;
            border: 2px solid;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .poi-icon.medical {
            color: #e74c3c;
            border-color: #e74c3c;
        }
        
        .poi-icon.toilet {
            color: #27ae60;
            border-color: #27ae60;
        }
        
        .poi-icon.water {
            color: #3498db;
            border-color: #3498db;
        }
        
        .poi-icon.default {
            color: #7f8c8d;
            border-color: #7f8c8d;
        }

        /* Settings Button */
        .settings-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(52, 73, 94, 0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .settings-btn:hover {
            background: rgba(52, 73, 94, 1);
            transform: rotate(90deg);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.4rem;
        }
        
        .close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .close:hover {
            background: #ecf0f1;
            color: #2c3e50;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .setting-group {
            margin-bottom: 1.5rem;
        }
        
        .setting-group h3 {
            margin: 0 0 1rem 0;
            color: #2c3e50;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .tile-option {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .tile-option:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }
        
        .tile-option.active {
            border-color: #3498db;
            background: #ebf3fd;
        }
        
        .tile-option input[type="radio"] {
            margin-right: 0.75rem;
            accent-color: #3498db;
        }
        
        .tile-info {
            flex: 1;
        }
        
        .tile-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }
        
        .tile-description {
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
            }
            
            .sidebar-header h1 {
                font-size: 1.5rem;
            }
        }

        /* Cookie Consent Banner */
        .cookie-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(44, 62, 80, 0.98);
            color: white;
            padding: 1rem;
            z-index: 10000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
            border-top: 3px solid #3498db;
        }
        
        .cookie-banner.show {
            transform: translateY(0);
        }
        
        .cookie-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        
        .cookie-text {
            flex: 1;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .cookie-text a {
            color: #3498db;
            text-decoration: underline;
        }
        
        .cookie-buttons {
            display: flex;
            gap: 0.75rem;
            flex-shrink: 0;
        }
        
        .cookie-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .cookie-btn.accept {
            background: #27ae60;
            color: white;
        }
        
        .cookie-btn.accept:hover {
            background: #229954;
        }
        
        .cookie-btn.decline {
            background: transparent;
            color: #bdc3c7;
            border: 1px solid #7f8c8d;
        }
        
        .cookie-btn.decline:hover {
            background: #7f8c8d;
            color: white;
        }
        
        @media (max-width: 768px) {
            .cookie-content {
                flex-direction: column;
                text-align: center;
            }
            
            .cookie-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .cookie-btn {
                flex: 1;
                max-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" alt="4Daagse GPX Logo" class="logo">
                <h1>4Daagse GPX</h1>
                <p>2025 Route en GPX downloads</p>
                <button class="settings-btn" id="settingsBtn" title="Instellingen">
                    <i class="material-icons">settings</i>
                </button>
            </div>
            
            <div class="sidebar-content">
                <div id="file-groups">
                    <div class="loading">Loading routes...</div>
                </div>
                
                <div class="github-link">
                    <a href="https://github.com/mark-boots" target="_blank" rel="noopener noreferrer">
                        <svg class="github-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 0C5.374 0 0 5.373 0 12 0 17.302 3.438 21.8 8.207 23.387c.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0112 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/>
                        </svg>
                        Mark Boots
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <button class="control-btn" onclick="fitAllRoutes()" title="Toon alle zichtbare routes">üìç Toon Alles</button>
                <button class="control-btn" onclick="clearAllRoutes()" title="Verwijder alle routes">üóëÔ∏è Wissen</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let currentTileLayer;
        let routeLayers = {};
        let routeColors = {
            '30km': '#3498db',      // Blue
            '40km': '#f1c40f',      // Yellow  
            '40kmM': '#27ae60',     // Green for 40km MIL/ML
            '50km': '#e74c3c',      // Red
            'Toiletten': '#27ae60', // Green
            'Medische': '#e74c3c',  // Red
            'Waterpunten': '#3498db' // Blue
        };
        let allGpxFiles = [];
        
        // Tile layer definitions
        const tileLayers = {
            osm: {
                name: 'OpenStreetMap',
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '¬© OpenStreetMap contributors'
            },
            satellite: {
                name: 'Satelliet',
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: '¬© Esri & contributors'
            },
            topo: {
                name: 'Topografisch',
                url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
                attribution: '¬© OpenTopoMap contributors'
            },
            dark: {
                name: 'Donker Thema',
                url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                attribution: '¬© <a href="https://carto.com/attributions">CARTO</a>'
            },
            smooth: {
                name: 'Glad & Schoon',
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                attribution: '¬© <a href="https://carto.com/attributions">CARTO</a>'
            }
        };
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([51.8426, 5.8518], 11); // Nijmegen center
            
            // Set initial tile layer
            setTileLayer('smooth');
        }
        
        // Set tile layer
        function setTileLayer(layerKey) {
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }
            
            const layer = tileLayers[layerKey];
            currentTileLayer = L.tileLayer(layer.url, {
                attribution: layer.attribution
            }).addTo(map);
        }
        
        // Modal functionality
        function initModal() {
            const modal = document.getElementById('settingsModal');
            const settingsBtn = document.getElementById('settingsBtn');
            const closeBtn = document.getElementById('closeModal');
            const tileOptions = document.querySelectorAll('.tile-option');
            
            // Open modal
            settingsBtn.addEventListener('click', () => {
                modal.style.display = 'block';
            });
            
            // Close modal
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Handle tile layer selection
            tileOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const tileKey = option.dataset.tile;
                    const radio = option.querySelector('input[type="radio"]');
                    
                    // Update radio selection
                    radio.checked = true;
                    
                    // Update visual selection
                    tileOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    
                    // Change tile layer
                    setTileLayer(tileKey);
                    
                    // Save preference
                    localStorage.setItem('preferredTileLayer', tileKey);
                });
            });
            
            // Load saved preference
            const savedLayer = localStorage.getItem('preferredTileLayer');
            if (savedLayer && tileLayers[savedLayer]) {
                const option = document.querySelector(`[data-tile="${savedLayer}"]`);
                if (option) {
                    option.click();
                }
            }
        }
        
        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initModal();
            loadGpxFiles();
        });

        async function loadGpxFiles() {
            try {
                console.log('Loading GPX files from ./gpx-files.json');
                const response = await fetch('./gpx-files.json');
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Loaded data:', data);
                
                if (data.success) {
                    allGpxFiles = data.files;
                    console.log('Files loaded:', allGpxFiles.length);
                    displayFileGroups(allGpxFiles);
                } else {
                    showError('Failed to load GPX files: ' + data.error);
                }
            } catch (error) {
                console.error('Error details:', error);
                showError('Error loading GPX files: ' + error.message);
            }
        }

        function displayFileGroups(files) {
            const container = document.getElementById('file-groups');
            
            if (files.length === 0) {
                container.innerHTML = '<div class="loading">No GPX files found. Convert some KML files first!</div>';
                return;
            }

            // Group files by day
            const groupedFiles = groupFilesByDay(files);
            
            const html = Object.keys(groupedFiles).sort().map(dayKey => {
                const group = groupedFiles[dayKey];
                const trackFiles = group.files.filter(f => f.type === 'track');
                const poiFiles = group.files.filter(f => f.type === 'poi');
                
                return `
                    <div class="day-group">
                        <div class="day-group-header day-${dayKey}" onclick="toggleGroup('${dayKey}')">
                            <span>${group.displayName}</span>
                        </div>
                        <div class="day-files" id="day-${dayKey}">
                            ${group.files.map(file => `
                                <div class="file-item" onclick="toggleFileItem('${file.fileName.replace(/[^a-zA-Z0-9]/g, '_')}')">
                                    <input type="checkbox" class="file-checkbox" 
                                           id="file-${file.fileName.replace(/[^a-zA-Z0-9]/g, '_')}"
                                           onchange="toggleRoute('${file.fileName}', this.checked)"
                                           style="color: ${getRouteColor(file.fileName)}; border-color: ${getRouteColor(file.fileName)};">
                                    <div class="file-info">
                                        <div class="file-name">${getDisplayFileName(file.fileName)}</div>
                                    </div>
                                    <a href="./gpx/${encodeURIComponent(file.fileName)}" 
                                       class="download-link" title="Download GPX" onclick="event.stopPropagation();">gpx</a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function groupFilesByDay(files) {
            const groups = {};
            
            files.forEach(file => {
                const dayMatch = file.fileName.match(/Dag_(\d+)/);
                const day = dayMatch ? dayMatch[1] : 'Unknown';
                
                const dayNames = {
                    '1': 'Dag 1 - Blauwe Dinsdag',
                    '2': 'Dag 2 - Roze Woensdag', 
                    '3': 'Dag 3 - Groene Donderdag',
                    '4': 'Dag 4 - Oranje Vrijdag'
                };
                
                const groupKey = day;
                
                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        displayName: dayNames[day] || `Dag ${day}`,
                        files: []
                    };
                }
                
                groups[groupKey].files.push(file);
            });
            
            // Sort files within each group
            Object.keys(groups).forEach(key => {
                groups[key].files.sort((a, b) => {
                    if (a.type !== b.type) {
                        return a.type === 'track' ? -1 : 1;
                    }
                    return a.fileName.localeCompare(b.fileName);
                });
            });
            
            return groups;
        }

        function getDayHeaderColor(dayKey) {
            const dayColors = {
                '1': '#3498db',    // Day 1: Blue
                '2': '#e91e63',    // Day 2: Pink  
                '3': '#4caf50',    // Day 3: Green
                '4': '#ff9800'     // Day 4: Orange
            };
            
            return dayColors[dayKey] || '#3498db'; // Default to blue
        }

        function getDisplayFileName(fileName) {
            let displayName = fileName
                .replace(/4Daagse2025_-_Dag_\d+_/, '') // Remove prefix
                .replace('.gpx', ''); // Remove file extension first
            
            // Handle specific patterns
            if (displayName.includes('30km_30km')) {
                displayName = '30km';
            } else if (displayName.includes('40km_40km')) {
                displayName = '40km';
            } else if (displayName.includes('50km_50km')) {
                displayName = '50km';
            } else if (displayName.includes('40kmM')) {
                displayName = '40km MIL';
            } else if (displayName.includes('Medische_verzorgingsposten')) {
                displayName = 'Verzorgingsposten';
            } else if (displayName.includes('Toiletten')) {
                displayName = 'Toiletten';
            } else if (displayName.includes('Waterpunten') || displayName.includes('Watertappunten')) {
                displayName = 'Waterpunten';
            } else {
                // General cleanup for other cases
                displayName = displayName
                    .replace(/_track$/, '') // Remove _track suffix
                    .replace(/_waypoints$/, '') // Remove _waypoints suffix
                    .replace(/_\w+$/, '') // Remove any other suffix
                    .replace(/_/g, ' ') // Replace underscores with spaces
                    .replace(/\b\w/g, l => l.toUpperCase()); // Capitalize words
            }
            
            return displayName;
        }

        function toggleGroup(dayKey) {
            const element = document.getElementById(`day-${dayKey}`);
            const header = element.previousElementSibling;
            
            element.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }

        function toggleFileItem(checkboxId) {
            const checkbox = document.getElementById(`file-${checkboxId}`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                // Trigger the onchange event manually
                const event = new Event('change');
                checkbox.dispatchEvent(event);
            }
        }

        async function toggleRoute(fileName, show) {
            if (show) {
                await loadAndDisplayRoute(fileName);
            } else {
                removeRoute(fileName);
            }
        }

        async function loadAndDisplayRoute(fileName) {
            try {
                // Show loading state
                const checkbox = document.getElementById(`file-${fileName.replace(/[^a-zA-Z0-9]/g, '_')}`);
                const originalLabel = checkbox.nextElementSibling.querySelector('.file-name').textContent;
                checkbox.nextElementSibling.querySelector('.file-name').textContent = 'Loading...';
                
                const response = await fetch(`./gpx/${encodeURIComponent(fileName)}`);
                const gpxText = await response.text();
                
                // Parse GPX and add to map
                const color = getRouteColor(fileName);
                const layer = parseAndDisplayGPX(gpxText, color, fileName);
                
                if (layer) {
                    routeLayers[fileName] = layer;
                    map.addLayer(layer);
                }
                
                // Restore label
                checkbox.nextElementSibling.querySelector('.file-name').textContent = originalLabel;
                
            } catch (error) {
                console.error('Error loading route:', error);
                // Uncheck the checkbox on error
                const checkbox = document.getElementById(`file-${fileName.replace(/[^a-zA-Z0-9]/g, '_')}`);
                checkbox.checked = false;
                checkbox.nextElementSibling.querySelector('.file-name').textContent = 'Error loading';
            }
        }

        function parseAndDisplayGPX(gpxText, color, fileName) {
            const parser = new DOMParser();
            const gpx = parser.parseFromString(gpxText, 'text/xml');
            
            const layerGroup = L.layerGroup();
            
            // Parse track points
            const trkpts = gpx.querySelectorAll('trkpt');
            if (trkpts.length > 0) {
                const coordinates = Array.from(trkpts).map(pt => [
                    parseFloat(pt.getAttribute('lat')),
                    parseFloat(pt.getAttribute('lon'))
                ]);
                
                const polyline = L.polyline(coordinates, {
                    color: color,
                    weight: 4,
                    opacity: 0.8
                }).bindPopup(`<strong>${getDisplayFileName(fileName)}</strong><br>${coordinates.length} points`);
                
                layerGroup.addLayer(polyline);
            }
            
            // Parse waypoints
            const waypoints = gpx.querySelectorAll('wpt');
            waypoints.forEach(wpt => {
                const lat = parseFloat(wpt.getAttribute('lat'));
                const lon = parseFloat(wpt.getAttribute('lon'));
                const name = wpt.querySelector('name')?.textContent || 'Waypoint';
                
                // Create custom icon based on POI type
                const iconInfo = getPOIIcon(fileName);
                const customIcon = L.divIcon({
                    html: `<div class="poi-icon ${iconInfo.class}"><span class="material-icons">${iconInfo.icon}</span></div>`,
                    className: 'custom-poi-marker',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker([lat, lon], {
                    icon: customIcon
                }).bindPopup(`<strong>${name}</strong>`);
                
                layerGroup.addLayer(marker);
            });
            
            return layerGroup;
        }

        function getPOIIcon(fileName) {
            // Determine icon based on filename
            if (fileName.toLowerCase().includes('medische') || fileName.toLowerCase().includes('verzorgingsposten')) {
                return {
                    icon: 'medical_services',
                    class: 'medical'
                };
            } else if (fileName.toLowerCase().includes('toiletten')) {
                return {
                    icon: 'wc',
                    class: 'toilet'
                };
            } else if (fileName.toLowerCase().includes('waterpunten') || fileName.toLowerCase().includes('watertappunten')) {
                return {
                    icon: 'water_drop',
                    class: 'water'
                };
            } else {
                // Default icon for other POI types
                return {
                    icon: 'place',
                    class: 'default'
                };
            }
        }

        function getRouteColor(fileName) {
            // Handle 40km MIL/ML cases first
            if (fileName.toLowerCase().includes('40kmm')) {
                return routeColors['40kmM'];
            }
            
            // Handle water points (both Waterpunten and Watertappunten)
            if (fileName.toLowerCase().includes('waterpunten') || fileName.toLowerCase().includes('watertappunten')) {
                return routeColors['Waterpunten'];
            }
            
            // Handle other route types
            for (const [key, color] of Object.entries(routeColors)) {
                if (key !== '40kmM' && key !== 'Waterpunten' && fileName.toLowerCase().includes(key.toLowerCase())) {
                    return color;
                }
            }
            return '#7f8c8d'; // Default gray
        }

        function removeRoute(fileName) {
            if (routeLayers[fileName]) {
                map.removeLayer(routeLayers[fileName]);
                delete routeLayers[fileName];
            }
        }

        function fitAllRoutes() {
            const allBounds = [];
            Object.values(routeLayers).forEach(layer => {
                layer.eachLayer(sublayer => {
                    if (sublayer.getBounds) {
                        allBounds.push(sublayer.getBounds());
                    }
                });
            });
            
            if (allBounds.length > 0) {
                const group = new L.featureGroup();
                allBounds.forEach(bounds => {
                    L.rectangle(bounds).addTo(group);
                });
                map.fitBounds(group.getBounds(), { padding: [20, 20] });
            }
        }

        function clearAllRoutes() {
            // Uncheck all checkboxes
            document.querySelectorAll('.file-checkbox:checked').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Remove all routes from map
            Object.keys(routeLayers).forEach(fileName => {
                removeRoute(fileName);
            });
        }

        function showError(message) {
            console.error(message);
            document.getElementById('file-groups').innerHTML = `<div class="loading" style="color: #e74c3c;">${message}</div>`;
        }
    </script>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Instellingen</h2>
                <button class="close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <h3>Kaart Stijl</h3>
                    
                    <div class="tile-option" data-tile="osm">
                        <input type="radio" name="tileLayer" value="osm">
                        <div class="tile-info">
                            <div class="tile-name">OpenStreetMap</div>
                            <div class="tile-description">Standaard straatkaart</div>
                        </div>
                    </div>
                    
                    <div class="tile-option" data-tile="satellite">
                        <input type="radio" name="tileLayer" value="satellite">
                        <div class="tile-info">
                            <div class="tile-name">Satelliet</div>
                            <div class="tile-description">Luchtfoto's van de route</div>
                        </div>
                    </div>
                    
                    <div class="tile-option" data-tile="topo">
                        <input type="radio" name="tileLayer" value="topo">
                        <div class="tile-info">
                            <div class="tile-name">Topografisch</div>
                            <div class="tile-description">Hoogtelijnen en terrein</div>
                        </div>
                    </div>
                    
                    <div class="tile-option" data-tile="dark">
                        <input type="radio" name="tileLayer" value="dark">
                        <div class="tile-info">
                            <div class="tile-name">Donker Thema</div>
                            <div class="tile-description">Donkere achtergrond</div>
                        </div>
                    </div>
                    
                    <div class="tile-option active" data-tile="smooth">
                        <input type="radio" name="tileLayer" value="smooth" checked>
                        <div class="tile-info">
                            <div class="tile-name">Glad & Schoon</div>
                            <div class="tile-description">Moderne, gladde kaart stijl</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cookie Consent Banner -->
    <div id="cookieBanner" class="cookie-banner">
        <div class="cookie-content">
            <div class="cookie-text">
                üç™ Deze website gebruikt Google Analytics cookies om bezoekersstatistieken te verzamelen. 
                Door op "Accepteren" te klikken, geef je toestemming voor het gebruik van cookies conform de GDPR wetgeving.
            </div>
            <div class="cookie-buttons">
                <button class="cookie-btn decline" onclick="declineCookies()">Weigeren</button>
                <button class="cookie-btn accept" onclick="acceptCookies()">Accepteren</button>
            </div>
        </div>
    </div>

    <script>
        // Cookie consent management
        function checkCookieConsent() {
            const consent = localStorage.getItem('cookieConsent');
            if (consent === null) {
                // Show banner after a short delay
                setTimeout(() => {
                    document.getElementById('cookieBanner').classList.add('show');
                }, 1000);
            } else if (consent === 'accepted') {
                // Initialize Google Analytics
                initializeGoogleAnalytics();
            }
        }
        
        function acceptCookies() {
            localStorage.setItem('cookieConsent', 'accepted');
            document.getElementById('cookieBanner').classList.remove('show');
            initializeGoogleAnalytics();
        }
        
        function declineCookies() {
            localStorage.setItem('cookieConsent', 'declined');
            document.getElementById('cookieBanner').classList.remove('show');
            // Disable Google Analytics
            window['ga-disable-G-8VKEJQ9E9E'] = true;
        }
        
        function initializeGoogleAnalytics() {
            // Only initialize if not already loaded
            if (!window.gtag) {
                // Create and load the Google Analytics script
                const script = document.createElement('script');
                script.async = true;
                script.src = 'https://www.googletagmanager.com/gtag/js?id=G-8VKEJQ9E9E';
                document.head.appendChild(script);
                
                // Initialize gtag
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                window.gtag = gtag;
                gtag('js', new Date());
                gtag('config', 'G-8VKEJQ9E9E');
            }
        }
        
        // Check consent when page loads
        document.addEventListener('DOMContentLoaded', checkCookieConsent);
    </script>

</body>
</html>
